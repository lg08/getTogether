{% load static %}

{% for post in posts %}
    <div class="card clickable-card post_card"
         id="card-for{{ post.id }}"
         >
        <!--          onclick="window.location='#'" -->


        <!-- for images -->
        <!-- <img class="card-img-top" src="..." alt="Card image cap"> -->
        <div class="card-body">
            <!-- help from here: https://slickmedia.co.uk/blog/glenns-blog/trigger-bootstrap-modal-with-link/ -->
            <!-- <a data-toggle="modal" class="stretched-link" href="#post_modal" id="modal_trigger"></a> -->
            <h5 class="card-title">{{ post.title }}</h5>

            <hr/>

            <p class="card-text" onclick="show_modal('#card-for{{ post.id }}')">{{ post.message }}</p>
            <a onclick="upvoteAJAX('{{ post.id }}')">
                upvote
            </a>
            <a onclick="downvoteAJAX('{{ post.id }}')">
                downvote
            </a>
            <p>
                upvotes: <span id="upvotes-for{{ post.id }}"></span>
            </p>
            <p>
                downvotes: <span id="downvotes-for{{ post.id }}"></span>
            </p>
            <p>Created by <a href="">{{ post.creator }}</a> at {{ post.created_at }}</p>
        </div>
    </div>

    <script>
        'use strict';
        
        function updateUpDown(postid, upvotes, downvotes){
            document.getElementById("upvotes-for" + String(postid)).innerHTML = String(upvotes);
            document.getElementById("downvotes-for" + String(postid)).innerHTML = String(downvotes);
            
        }

        window.onload = updateUpDown("{{ post.id }}", "{{ post.num_of_upvotes }}", "{{ post.num_of_downvotes }}");

        var controller = null;
        function upvoteAJAX(postid) {
            let url = "/posts/upvote/" + String(postid);
            if (controller !== null)
                controller.abort();
            controller = new AbortController();
            fetch(url, {signal: controller.signal})
                .then(response => response.json())
                .then(data => updateUpDown(data.postid, data.upvotes, data.downvotes))
                .catch(function(err) {console.log(err);});
        }

        function downvoteAJAX(postid) {
            let url = "/posts/downvote/" + String(postid);
            if (controller !== null)
                controller.abort();
            controller = new AbortController();

            fetch(url, {signal: controller.signal})
                .then(response => response.json())
                .then(data => updateUpDown(data.postid, data.upvotes, data.downvotes))
                .catch(function(err) {console.log(err);});
        }

    </script>
{% endfor %}
